<!DOCTYPE html><html><head>
<title>README.md</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=1024, user-scalable=no">

<!-- Required stylesheet -->
<link rel="stylesheet" href="deck.js/core/deck.core.css">

<!-- Extension CSS files go here. Remove or add as needed. -->
<link rel="stylesheet" href="deck.js/extensions/goto/deck.goto.css">
<link rel="stylesheet" href="deck.js/extensions/menu/deck.menu.css">
<link rel="stylesheet" href="deck.js/extensions/navigation/deck.navigation.css">
<link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
<link rel="stylesheet" href="deck.js/extensions/hash/deck.hash.css">
<link rel="stylesheet" href="deck.js/extensions/scale/deck.scale.css">
<!-- Style theme. More available in /themes/style/ or create your own. -->
<link rel="stylesheet" href="amir-deck.css">

<!-- Transition theme. More available in /themes/transition/ or create your own. -->
<link rel="stylesheet" href="deck.js/themes/transition/vertical-slide.css">

<!-- Required Modernizr file -->
<script src="deck.js/modernizr.custom.js"></script>

<!-- Roboto Slab typeface -->
<link href='http://fonts.googleapis.com/css?family=Roboto+Slab:300,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cardo:400,400italic,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<!-- Google Code Prettify -->
<link rel="stylesheet" href="google-code-prettify/styles/desert.css">
</head><body class='deck-container'><section class='slide'>
<div style="position: absolute; height: 97%; width: 100%;">
  <div style="margin:30px auto 50px 0px; width: 90%; text-align: center">
    <h2 style="font-size:1.8em; font-weight:bold;">
      Test Driven Drupal Upgrades
    </h2>
    <div style="font-size:0.7em;">
      <div style="font-size:1.2em; font-weight:bold;">Dave Vasilevsky</div>
      <div> vasi@evolvingweb.ca </div>
      <div> github.com/vasi </div>
      <div> twitter.com/djvasi </div>
      <div> drupal.org/u/vasi </div>
    </div>
  </div>

  <p><img src="img/ew-good.png" style="height:130px; margin: 10px 0 0 0; position: absolute; bottom: 0;"></p>
</div>

</section><section class='slide'>

<h2>Outline</h2>

<ul>
<li><strong>About me</strong></li>
<li><strong>Intro</strong></li>
<li><strong>Basics</strong>
<ul>
<li>Minor Updates</li>
<li>Major Core Upgrades</li>
<li>Testing</li>
</ul></li>
<li><strong>Tools</strong>
<ul>
<li>behat</li>
<li>docker</li>
<li>CircleCI
<ul>
<li><strong>drupal-docker-marriage demo</strong></li>
</ul></li>
<li>PHPUnit</li>
<li>sitediff
<ul>
<li><strong>SiteDiff demo</strong></li>
</ul></li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>About Evolving Web</h2>

<ul>
<li>Drupal development, consulting and training since 2007</li>
<li>Very involved with the Drupal community</li>
<li>Specialties
<ul>
<li>Large, scalable infrastructure and deployments</li>
<li>Multilingual content management</li>
<li>Apache Solr search interfaces</li>
<li>Content import and synchronization</li>
<li>Custom theme development</li>
<li>Custom module development</li>
<li>Search engine optimization for Drupal (SEO)</li>
<li>Integration with legacy systems</li>
<li>Expert Drupal training</li>
</ul></li>
<li>Based in Montreal, clients in Canada and USA</li>
<li>EW is hiring! Let us know if you're interested</li>
</ul>

</section><section class='slide'>

<p><img src="img/ew-projects.png" alt="" title="" /></p>

</section><section class='slide'>

<h2>Drupal training program</h2>

<p><img src="https://evolvingweb.ca/sites/default/files/d7/_Q4A1828_0.jpg" width="25%" style="float: right; margin-left: 40px; margin-right: 20px" /></p>

<ul>
<li>Public: Montreal, Ottawa, Toronto, DC, Munich, NJ, NYC, Boston, Chicago</li>
<li>Private: Health Canada, Parks Canada, Tourism Quebec, Trent U, McGill U</li>
<li>Enterprise teams, dev shops, remote</li>
</ul>

</section><section class='slide'>

<h2>About me</h2>

<ul>
<li>I've been at Evolving Web since 2008, taught my coworkers about version control
<ul>
<li>Working with Drupal since D6</li>
</ul></li>
<li>Participate in lots of open source projects: Fink, Firefox, grub, pixz, and of course Drupal core!</li>
</ul>

</section><section class='slide'>

<h2>Introduction</h2>

<ul>
<li>Upgrades are important for security
<ul>
<li>Security bugs are constantly found in Drupal and Drupal modules</li>
<li>Eg: Drupalgeddon (SA-CORE-2014-005) fixed in 7.32</li>
</ul></li>
<li>Upgrades bring new features
<ul>
<li>Drupal 7 has many performance improving features over D6</li>
<li>Webform 4 brings token support</li>
</ul></li>
<li>Drupal 6 is now EOL! No more security fixes</li>
</ul>

</section><section class='slide'>

<h2>Introduction</h2>

<ul>
<li>Many Drupal developers aren't great at upgrading. Why?
<ul>
<li>Not everyone knows how</li>
<li>It can take time</li>
<li>We're afraid of regressions</li>
<li>We hate manual testing</li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>How to change</h2>

<ul>
<li>Learn how to do upgrades</li>
<li>Good tools make it easier and faster</li>
<li>Testing makes it safe</li>
</ul>

</section><section class='slide'>

<h2>Minor updates vs. major upgrades</h2>

<ul>
<li>Minor updates: 7.35 -> 7.36
<ul>
<li>Modules need updates too!</li>
<li>Perform these as often as possible, to keep up with security fixes</li>
</ul></li>
<li>Major upgrades: 6.28 -> 8.0.5
<ul>
<li>Bring many, many new features and opportunities</li>
<li>Necessary before D6 is obsolute</li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>Minor update basics</h2>

<ul>
<li>When to update: Use the Drupal Security Advisories mailing list: https://www.drupal.org/security
<ul>
<li>Or use the update module</li>
</ul></li>
<li>Where to update: In staging
<ul>
<li>Never do an update for the first time in production, you don't know if anything will break</li>
</ul></li>
<li>Watch out for hacks or patches to your modules!
<ul>
<li>Use the <code>hacked</code> module to find them</li>
</ul></li>
</ul>

<p><img src="img/update-module.png" alt="" title="" /></p>

</section><section class='slide'>

<h2>Minor update basics</h2>

<ul>
<li>How to update in place:
<ul>
<li><code>drush pm-updatestatus</code> to list available updates</li>
<li><code>drush pm-update</code> to perform updates</li>
</ul></li>
<li>For real sites in production:
<ul>
<li>Perform manual update on dev/staging, test</li>
<li>Commit</li>
<li>Deploy to staging and test</li>
<li>Deploy on prod</li>
</ul></li>
<li>Update hooks
<ul>
<li>Keep database in sync with versions of code</li>
<li>Eg: new column in database; rename variable</li>
<li>Running them: <code>update.php</code> or <code>drush updb</code></li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>Major upgrade basics</h2>

<p>...</p>

</section><section class='slide'>

<h2>Major upgrade basics</h2>

<p>The first rule of major upgrades is there is no such thing as a basic major upgrade.</p>

</section><section class='slide'>

<h2>Major upgrade basics</h2>

<ul>
<li>Major upgrades can be as hard as a site rebuild
<ul>
<li>Drupal changes in ways that aren't backwards-compatible</li>
<li>Modules may not be updated yet, or at all</li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>Major upgrades, grandpa style</h2>

<p>You might still want to do D6 to D7 upgrades sometimes:</p>

<ul>
<li>Avoid D6 EOL</li>
<li>Can perform the update in-place</li>
<li>Your custom modules might need only small fixes</li>
</ul>

</section><section class='slide'>

<h2>Major upgrades, grandpa style</h2>

<p>In D6:</p>

<ul>
<li>Update core and contrib to latest D6 version</li>
<li>Minimize the site: disable custom theme, modules, some contrib</li>
</ul>

<p>Do the upgrade:</p>

<ul>
<li>Update core and contrib code to highest D7 version</li>
<li>Run <code>drush updb</code></li>
<li>Use content_migrate to move from CCK to fields</li>
<li>Upgrade and re-enable modules</li>
<li>Fix all the breakage! Lots of ways things can go wrong</li>
</ul>

</section><section class='slide'>

<h2>Major upgrades, D8</h2>

<p>No more in-place upgrades!</p>

<ul>
<li>Build your brand new D8 site
<ul>
<li>Can't keep your custom modules or theme</li>
</ul></li>
<li>Migrate content from your existing D6 or D7 site</li>
</ul>

</section><section class='slide'>

<h2>Major upgrades, D8</h2>

<p>For a simple site, it's easy:</p>

<ol>
<li>Create an empty D8 site, install migrate_upgrade</li>
<li>Visit `/upgrade', give D6/D7 DB credentials</li>
<li>Go!</li>
</ol>

<p>All your settings and content will be pulled into D8! But still...</p>

<ul>
<li>Lots of things aren't working yet, eg: multilingual content</li>
<li>Needs to rebuild custom modules and themes</li>
<li>Contrib modules may not be ready, eg: panels</li>
</ul>

</section><section class='slide'>

<h2>Major upgrades, D8</h2>

<p>For a more complex site, you might just want to do a site rebuild.</p>

<ul>
<li>Build a nice new site from scratch</li>
<li>But still get some or all content from D6/D7
<ul>
<li>Run <code>drush migrate-upgrade --configure</code> to configure upgrade migrations without running them</li>
<li>Then edit/remove migrate config files as desired</li>
<li>Use <code>drush migrate-import</code> from migrate_tools</li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>Testing basics</h2>

<ul>
<li>Unit testing</li>
<li>Integration testing</li>
<li>UI testing</li>
<li>Continuous integration</li>
</ul>

</section><section class='slide'>

<h2>Unit testing</h2>

<ul>
<li>Fast, good for standalone functions</li>
<li>Use fixtures for testing</li>
<li>Great for your custom modules, or core contributions</li>
<li>D7: SimpleTest (DrupalUnitTestCase)</li>
<li>D8: PHPUnit (UnitTestCase)</li>
<li>But when you update a contrib module, your unit tests won't care at all. They're not super useful for testing updates</li>
</ul>

</section><section class='slide'>

<h2>Integration testing</h2>

<ul>
<li>Tests how your module integrates with other modules
<ul>
<li>But only the modules that are necessary for your module to work, not the whole site</li>
</ul></li>
<li>D7: SimpleTest (DrupalWebTestCase)</li>
<li>D8: PHPUnit (KernelTestBase)</li>
<li>Powerful Drupal integration: Enable modules, create content, add users...</li>
<li>Can be really slow (esp. D7), may need to setup the DB for each test</li>
<li>Can't test things like JavaScript, CSS</li>
</ul>

</section><section class='slide'>

<h2>UI testing</h2>

<ul>
<li>Tests your site by controlling a real browser</li>
<li>Very powerful and thorough</li>
<li>Not built-in to Drupal, need external tools
<ul>
<li>Eg: Selenium, CasperJS, behat</li>
<li>May be built-in in 8.2?</li>
</ul></li>
<li>Great replacement for manual testing</li>
<li>Unlike above tests, there's no isolation. Your tests can change your site!</li>
</ul>

</section><section class='slide'>

<h2>Tools</h2>

<p>This is informative, but a lot of theory. How do we actually make it work in practice?</p>

<ul>
<li>What problems have we encountered on our projects?</li>
<li>What tools have we used to solve them?</li>
</ul>

</section><section class='slide'>

<h2>Case Study - Certification Tool</h2>

<p>An Internet of Things consortium needed to <a href="http://certify.alljoyn.org">certify products that met its standards</a>.</p>

<p>Challenges:</p>

<ul>
<li>Complex data, with constraints</li>
<li>Relationships between products</li>
<li>Complex permissions: editing and workflow</li>
<li>Slowly grew into giant, fragile forms of doom</li>
<li>Several developers</li>
</ul>

</section><section class='slide'>

<h2>Behat</h2>

<p>Problem: Every code change could break the form
<br />
Solution: Test the form's behavior</p>

<p>We used <a href="http://docs.behat.org">behat</a> and its <a href="https://behat-drupal-extension.readthedocs.org">Drupal extension</a></p>

<ul>
<li>Why BDD?</li>
<li>Why use behat?
<ul>
<li>UI testing</li>
<li>Drupal integration</li>
<li>Easily understood tests</li>
</ul></li>
<li>Found tons of bugs</li>
</ul>

</section><section class='slide'>

<h2>behat scenarios</h2>

<p>Here's an example of a test for behat:</p>

<pre class="prettyprint"><code>Scenario: Show author on hover
  Given I am viewing an "article" content:
  | title | author          | body  |
  | Lorem | bob@example.com | Ipsum |
  When I hover over the "author" region
  Then I should see the text "Bob"
</code></pre>

<p>Here's how we implemented the "hover" rule above, in a custom behat context:</p>

<pre class="prettyprint"><code>/**
  * @When I hover over the :region region
  */
public function iHoverOverRegion($region) {
  getRegion($region)-&gt;mouseOver();
}
</code></pre>

</section><section class='slide'>

<h2>Docker</h2>

<p>Problem: Bugs aren't reproducible
<br />
Solution: Put everyone in the same environment</p>

<ul>
<li>Easily build and run virtualized containers</li>
<li>Easy to spin up an exact copy of your site
<ul>
<li>If something breaks, just spin it up again</li>
<li>Very useful for minor updates!</li>
</ul></li>
<li>Consistent environment in dev/staging/prod</li>
</ul>

</section><section class='slide'>

<h2>Docker</h2>

<ul>
<li>Dockerfile build process
<ul>
<li>Starts with clean distro image</li>
<li>Installs all necessary packages: mysql, tomcat, solr, nginx, xhprof, xdebug, ...</li>
<li>Runs our deploy scripts</li>
</ul></li>
<li>Caching</li>
</ul>

<pre class="prettyprint">
FROM ubuntu:14.04
RUN apt-get update && apt-get install -y mysql apache2 ...
RUN a2enmod ssl
COPY code /var/www/html
...
</pre>

</section><section class='slide'>

<h2>Continuous integration</h2>

<p>Problem: Tests are slow, devs avoid running them
<br />
Solution: Run tests in the background</p>

<ul>
<li>Run your tests automatically for every commit</li>
<li>Usually uses a build server</li>
<li>Reports on the results</li>
</ul>

</section><section class='slide'>

<h2>CircleCI</h2>

<p>We use <a href="http://circleci.com">CircleCI</a> for our continuous integration:</p>

<ul>
<li>Integrates with GitHub branches and pull requests</li>
<li>Email notifications when something breaks</li>
<li>Catches event unexpected bugs, eg: servers disappearing, unmaintained packages</li>
<li>Allows use of docker, so test environment is consistent with dev/prod</li>
</ul>

</section><section class='slide'>

<h2>CircleCI</h2>

<p>CircleCI is configured with a circle.yml file:</p>

<pre class="prettyprint lang-yaml">
machine:
  services:
    - docker

dependencies:
  override:
    - docker build -t myproject .
    - docker run -p 9022:22 myproject

test:
  override:
    - "ssh -p 9022 drupal@localhost 'cd /var/www && drush test-run'"
</pre>

</section><section class='slide'>

<h2>Behat, CircleCI, Docker demo</h2>

<p><img src="img/pull-request-screenshot.png" alt="" title="" /></p>

<p><a href="https://github.com/evolvingweb/drupal-docker-marriage">github.com/evolvingweb/drupal-docker-marriage</a></p>

<p><a href="https://github.com/vasi/ew-presentations/blob/gh-pages/midcamp-2016-upgrades/demo-marriage.md">Demo notes</a></p>

</section><section class='slide'>

<h2>Case Study- McGill calendar</h2>

<p>McGill used a D6 site for their course calendar, wanted to go to D7.</p>

<p>Challenges:
* Many custom modules
* Lots of content, complex structure
* Legal requirement that it be correct and complete!
* Logically nested menus: menu + book</p>

</section><section class='slide'>

<h2>PHPUnit</h2>

<p>Problem: Merging menus is tricky
<br />
Solution: Tests with fixtures</p>

<ul>
<li>Single entry point to contain complexity</li>
<li>List of potential inputs and desired outputs</li>
</ul>

</section><section class='slide'>

<h2>SiteDiff</h2>

<p>Problem: Code must change, content must stay the same
<br />
Solution: Compare the content</p>

<p><a href="https://github.com/evolvingweb/sitediff">github.com/evolvingweb/sitediff</a></p>

<ul>
<li>Downloads list of pages from two sites</li>
<li>Computes diff of HTML</li>
<li>Cleans up spurious changes, like absolute domains</li>
<li>Reports changes via command-line UI and web report</li>
<li>Break down huge upgrade into simple tasks</li>
</ul>

</section><section class='slide'>

<h2>SiteDiff configuration</h2>

<pre class="prettyprint lang-yaml">
before_url: http://docker:9179
after_url: http://docker:9180
paths:
- /
- /about-us
- /user/3/track
sanitization:
- pattern: http:\/\/[a-zA-Z0-9.:-]+
  substitute: __domain__
</pre>

</section><section class='slide'>

<h2>SiteDiff output</h2>

<p><img src="img/sitediff-report.png" alt="" title="" />
<img src="img/sitediff-diff.png" alt="" title="" /></p>

</section><section class='slide'>

<h2>SiteDiff</h2>

<ul>
<li>Advantages:
<ul>
<li>Thoroughness</li>
<li>Black-box</li>
<li>Speed</li>
</ul></li>
<li>Limitations:
<ul>
<li>JavaScript</li>
<li>Dynamic content</li>
<li>Admin UI</li>
</ul></li>
</ul>

</section><section class='slide'>

<h2>SiteDiff</h2>

<p>SiteDiff turns out to be useful on many projects</p>

<ul>
<li>Refactorings</li>
<li>Dev vs Prod</li>
<li>Content migration</li>
<li>Upgrades! Little should change</li>
</ul>

</section><section class='slide'>

<h2>SiteDiff demo</h2>

<p><img src="img/sitediff-screenshot.png" alt="" title="" /></p>

<p><a href="https://github.com/vasi/sitediff-update-demo">github.com/vasi/sitediff-update-demo</a></p>

<p><a href="https://github.com/vasi/ew-presentations/blob/gh-pages/midcamp-2016-upgrades/demo-sitediff.md">Demo notes</a></p>

</section><section class='slide'>

<h2>Any questions?</h2>

<ul>
<li>Evolving Web: <a href="http://evolvingweb.ca">evolvingweb.ca</a></li>
<li>SiteDiff: <a href="https://github.com/evolvingweb/sitediff">github.com/evolvingweb/sitediff</a></li>
<li>Demo of SiteDiff: <a href="https://github.com/vasi/sitediff-update-demo">github.com/vasi/sitediff-update-demo</a></li>
<li>Demo of docker, behat, CircleCI: <a href="https://github.com/evolvingweb/drupal-docker-marriage">github.com/evolvingweb/drupal-docker-marriage</a></li>
</ul>

</section><section class='slide'>
</section>
<!-- End slides. -->


<!-- Begin extension snippets. Add or remove as needed. -->

<!-- deck.navigation snippet -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<!-- deck.status snippet -->
<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<!-- deck.goto snippet -->
<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
	<datalist id="goto-datalist"></datalist>
	<input type="submit" value="Go">
</form>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<!-- End extension snippets. -->


<!-- Required JS files. -->
<script src="deck.js/jquery-1.7.2.min.js"></script>
<script src="deck.js/core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="deck.js/core/deck.core.js"></script>
<script src="deck.js/extensions/hash/deck.hash.js"></script>
<script src="deck.js/extensions/menu/deck.menu.js"></script>
<script src="deck.js/extensions/goto/deck.goto.js"></script>
<script src="deck.js/extensions/status/deck.status.js"></script>
<script src="deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="deck.js/extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
	$(function() {
		$.deck('.slide');
	});
</script>
<script src="google-code-prettify/src/run_prettify.js?lang=yaml"></script>
</body></html>
